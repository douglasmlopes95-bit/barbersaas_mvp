{% extends "base.html" %}

{% block title %}Dashboard | {{ current_user.tenant.nome if current_user.tenant else "Barbearia" }}{% endblock %}

{% block content %}

<!-- ============================= -->
<!-- HEADER -->
<!-- ============================= -->
<div class="header" style="text-align:center; margin-bottom:20px;">

    {% if current_user.tenant and current_user.tenant.logo %}
        <img 
    src="{{ current_user.tenant.logo }}" 
    alt="Logo"
    style="
        max-height:130px;
        width:auto;
        max-width:100%;
        object-fit:contain;
        display:block;
        margin:0 auto 10px auto;
    ">

    {% endif %}

    <h1>
        Dashboard <span>{{ current_user.tenant.nome if current_user.tenant else "Barbearia" }}</span>
    </h1>

</div>

<!-- ============================= -->
<!-- TABS -->
<!-- ============================= -->
<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event,'overview')">Visão Geral</button>
    <button class="tab-btn" onclick="openTab(event,'services')">Serviços</button>
    <button class="tab-btn" onclick="openTab(event,'barbers')">Barbeiros</button>
    <button class="tab-btn" onclick="openTab(event,'slots')">Horários</button>
    <button class="tab-btn" onclick="openTab(event,'cash')">Caixa</button>
    <button class="tab-btn" onclick="openTab(event,'reports')">Relatórios</button>

    {% if current_user.is_tenant_admin() %}
    <button class="tab-btn" onclick="openTab(event,'company')">Dados da Empresa</button>
    {% endif %}
</div>

<!-- ============================= -->
<!-- VISÃO GERAL -->
<!-- ============================= -->
<div id="overview" class="tab-content active">

    <div class="cards">
        <div class="card">
            <h3>Serviços</h3>
            <p>{{ services|length }}</p>
        </div>
        <div class="card">
            <h3>Barbeiros</h3>
            <p>{{ barbers|length }}</p>
        </div>
        <div class="card">
            <h3>Agendamentos</h3>
            <p>{{ appointments|length }}</p>
        </div>
    </div>

    <!-- FILTROS -->
    <div class="card">
        <h3>Filtros da Agenda</h3>

        <form method="GET" style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
            <div class="form-group">
                <label>Data</label>
                <input type="date" name="data" value="{{ request.args.get('data','') }}">
            </div>

            <div class="form-group">
                <label>Status</label>
                <select name="status">
                    <option value="">Todos</option>
                    {% for s in ["AGENDADO","CONCLUIDO","CANCELADO"] %}
                        <option value="{{ s }}" {% if request.args.get('status')==s %}selected{% endif %}>
                            {{ s }}
                        </option>
                    {% endfor %}
                </select>
            </div>

            {% if current_user.is_tenant_admin() %}
            <div class="form-group">
                <label>Barbeiro</label>
                <select name="barber_id">
                    <option value="">Todos</option>
                    {% for barber in barbers %}
                        <option value="{{ barber.id }}"
                            {% if request.args.get('barber_id') == barber.id|string %}selected{% endif %}>
                            {{ barber.nome }}
                        </option>
                    {% endfor %}
                </select>
            </div>
            {% endif %}

            <button class="btn btn-gold">Filtrar</button>
            <a href="{{ url_for('tenant.dashboard') }}" class="btn btn-sm">Limpar</a>
        </form>
    </div>

    <!-- AGENDA -->
    <div class="card">
        <h3>Agenda</h3>

        {% if appointments %}
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Barbeiro</th>
                    <th>Status</th>
                    <th>Ações</th>
                </tr>
            </thead>
            <tbody>
                {% for appt in appointments %}
                <tr>
                    <td>{{ appt.data_hora.strftime("%d/%m/%Y %H:%M") }}</td>
                    <td>{{ appt.cliente_nome }}</td>
                    <td>{{ appt.barber.nome if appt.barber else "-" }}</td>
                    <td>
                        <span class="badge badge-{{ 'success' if appt.status=='CONCLUIDO' else 'warning' if appt.status=='AGENDADO' else 'danger' }}">
                            {{ appt.status }}
                        </span>
                    </td>
                    <td>
                        {% if appt.status == "AGENDADO" %}
                        <form method="POST"
                              action="{{ url_for('tenant.complete_appointment', appointment_id=appt.id) }}"
                              onsubmit="return confirm('Concluir este serviço?');">
                            <button class="btn btn-sm btn-gold">Concluir</button>
                        </form>
                        {% else %}
                            <span class="muted">—</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">Nenhum agendamento encontrado.</p>
        {% endif %}
    </div>
</div>

<!-- ============================= -->
<!-- SERVIÇOS -->
<!-- ============================= -->
<div id="services" class="tab-content">
    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Novo Serviço</h3>
        <form method="POST">
            <input type="hidden" name="action" value="create_service">

            <div class="form-group">
                <label>Nome</label>
                <input type="text" name="nome" required>
            </div>

            <div class="form-group">
                <label>Descrição</label>
                <input type="text" name="descricao">
            </div>

            <div class="form-group">
                <label>Preço (R$)</label>
                <input type="number" step="0.01" name="preco" required>
            </div>

            <div class="form-group">
                <label>Duração (min)</label>
                <input type="number" name="duracao" value="30">
            </div>

            <div class="form-group">
                <label>Barbeiro Responsável</label>
                <select name="barber_id">
                    <option value="">Nenhum</option>
                    {% for barber in barbers %}
                        <option value="{{ barber.id }}">{{ barber.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <button class="btn btn-gold">Cadastrar Serviço</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Serviços Cadastrados</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Duração</th>
                    <th>Barbeiro</th>
                    {% if current_user.is_tenant_admin() %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for s in services %}
                <tr>
                    <td>{{ s.nome }}</td>
                    <td>R$ {{ "%.2f"|format(s.preco) }}</td>
                    <td>{{ s.duracao_min }} min</td>
                    <td>{{ s.barber.nome if s.barber else "-" }}</td>

                    {% if current_user.is_tenant_admin() %}
                    <td style="display:flex; gap:8px;">
                        <button class="btn btn-sm btn-warning"
                                onclick="document.getElementById('edit{{s.id}}').style.display='block'">
                            Editar
                        </button>

                        <form method="POST">
                            <input type="hidden" name="action" value="delete_service">
                            <input type="hidden" name="service_id" value="{{ s.id }}">
                            <button class="btn btn-sm btn-danger"
                                    onclick="return confirm('Excluir este serviço?')">
                                Excluir
                            </button>
                        </form>
                    </td>
                    {% endif %}
                </tr>

                <!-- MODAL EDITAR SERVIÇO -->
                <div id="edit{{s.id}}" class="modal"
                     style="display:none; position:fixed; top:0; left:0; width:100%; height:100%;
                            background:rgba(0,0,0,0.6); padding-top:80px;">
                    <div class="card" style="max-width:480px; margin:auto;">
                        <h3>Editar Serviço</h3>

                        <form method="POST">
                            <input type="hidden" name="action" value="edit_service">
                            <input type="hidden" name="service_id" value="{{ s.id }}">

                            <div class="form-group">
                                <label>Nome</label>
                                <input type="text" name="nome" value="{{ s.nome }}" required>
                            </div>

                            <div class="form-group">
                                <label>Descrição</label>
                                <input type="text" name="descricao" value="{{ s.descricao or '' }}">
                            </div>

                            <div class="form-group">
                                <label>Preço</label>
                                <input type="number" step="0.01" name="preco" value="{{ s.preco }}" required>
                            </div>

                            <div class="form-group">
                                <label>Duração (min)</label>
                                <input type="number" name="duracao" value="{{ s.duracao_min }}">
                            </div>

                            <div class="form-group">
                                <label>Barbeiro</label>
                                <select name="barber_id">
                                    <option value="">Nenhum</option>
                                    {% for barber in barbers %}
                                        <option value="{{ barber.id }}"
                                            {% if s.barber_id==barber.id %}selected{% endif %}>
                                            {{ barber.nome }}
                                        </option>
                                    {% endfor %}
                                </select>
                            </div>

                            <label>
                                <input type="checkbox" name="ativo" {% if s.ativo %}checked{% endif %}>
                                Ativo
                            </label>

                            <div style="display:flex; justify-content:flex-end; gap:8px;">
                                <button type="button" class="btn"
                                        onclick="document.getElementById('edit{{s.id}}').style.display='none'">
                                    Cancelar
                                </button>
                                <button class="btn btn-gold">Salvar</button>
                            </div>
                        </form>
                    </div>
                </div>

                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- BARBEIROS -->
<!-- ============================= -->
<div id="barbers" class="tab-content">
    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Novo Barbeiro</h3>
        <form method="POST">
            <input type="hidden" name="action" value="create_barber">

            <div class="form-group">
                <label>Nome</label>
                <input type="text" name="nome" required>
            </div>

            <div class="form-group">
                <label>E-mail</label>
                <input type="email" name="email" required>
            </div>

            <div class="form-group">
                <label>Senha</label>
                <input type="password" name="senha" required>
            </div>

            <button class="btn btn-gold">Cadastrar Barbeiro</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Barbeiros Ativos</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                    {% if current_user.is_tenant_admin() %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for b in barbers %}
                <tr>
                    <td>{{ b.nome }}</td>
                    <td>{{ b.email }}</td>
                    {% if current_user.is_tenant_admin() %}
                    <td>
                        <form method="POST">
                            <input type="hidden" name="action" value="delete_barber">
                            <input type="hidden" name="barber_id" value="{{ b.id }}">
                            <button class="btn btn-sm btn-danger"
                                    onclick="return confirm('Remover barbeiro?')">
                                Excluir
                            </button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- HORÁRIOS -->
<!-- ============================= -->
<div id="slots" class="tab-content">
    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Gerar Horários</h3>
        <form method="POST">
            <input type="hidden" name="action" value="generate_slots">

            <div class="form-group">
                <label>Barbeiro</label>
                <select name="barber_id" required>
                    <option value="">Selecione</option>
                    {% for barber in barbers %}
                        <option value="{{ barber.id }}">{{ barber.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Dias da semana</label>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    {% for d in [('0','Seg'),('1','Ter'),('2','Qua'),('3','Qui'),('4','Sex'),('5','Sáb'),('6','Dom')] %}
                        <label>
                            <input type="checkbox" name="weekdays" value="{{ d[0] }}"> {{ d[1] }}
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label>Hora início</label>
                <input type="time" name="hora_inicio" required>
            </div>

            <div class="form-group">
                <label>Hora fim</label>
                <input type="time" name="hora_fim" required>
            </div>

            <div class="form-group">
                <label>Intervalo (min)</label>
                <select name="intervalo">
                    <option value="15">15</option>
                    <option value="30" selected>30</option>
                    <option value="60">60</option>
                </select>
            </div>

            <div class="form-group">
                <label>Data início</label>
                <input type="date" name="data_inicio" required>
            </div>

            <div class="form-group">
                <label>Data fim</label>
                <input type="date" name="data_fim" required>
            </div>

            <button class="btn btn-gold">Gerar Horários</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Horários Cadastrados</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Barbeiro</th>
                    <th>Status</th>
                    {% if current_user.is_tenant_admin() %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for slot in slots %}
                <tr>
                    <td>{{ slot.data.strftime("%d/%m/%Y") }}</td>
                    <td>{{ slot.hora.strftime("%H:%M") }}</td>
                    <td>{{ slot.barber.nome if slot.barber else "-" }}</td>
                    <td>
                        <span class="badge badge-{{ 'success' if slot.disponivel else 'danger' }}">
                            {{ slot.status }}
                        </span>
                    </td>
                    {% if current_user.is_tenant_admin() %}
                    <td style="display:flex; gap:6px;">
                        <form method="POST"
                              action="{{ url_for('tenant.toggle_slot', slot_id=slot.id) }}">
                            <button class="btn btn-sm">
                                {% if slot.disponivel %}Bloquear{% else %}Liberar{% endif %}
                            </button>
                        </form>

                        <form method="POST"
                              action="{{ url_for('tenant.delete_slot', slot_id=slot.id) }}"
                              onsubmit="return confirm('Excluir este horário?');">
                            <button class="btn btn-sm btn-danger">Excluir</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- FINANCEIRO / CAIXA / RELATÓRIOS -->
<!-- ============================= -->
<div id="finance" class="tab-content">
    <div class="card">
        <a href="{{ url_for('tenant.go_reports') }}" class="btn btn-gold">Abrir Financeiro</a>
    </div>
</div>

<div id="cash" class="tab-content">
    <div class="card">
        <a href="{{ url_for('tenant.go_cash') }}" class="btn btn-gold">Acessar Caixa</a>
    </div>
</div>

<div id="reports" class="tab-content">
    <div class="card">
        <a href="{{ url_for('tenant.go_reports') }}" class="btn btn-gold">Ver Relatórios</a>
    </div>
</div>

<!-- ============================= -->
<!-- DADOS DA EMPRESA -->
<!-- ============================= -->
{% if current_user.is_tenant_admin() %}
<div id="company" class="tab-content">
    <div class="card">
        <h3>Dados da Empresa</h3>

        <form method="POST" action="{{ url_for('tenant.company_settings') }}" enctype="multipart/form-data">

            {% if current_user.tenant.logo %}
            <div style="margin-bottom:10px;">
                <strong>Logo Atual:</strong><br>
                <img src="{{ current_user.tenant.logo }}" style="max-height:120px;">
            </div>
            {% endif %}

            <div class="form-group">
                <label>Enviar nova logo</label>
                <input type="file" name="logo" accept="image/*">
            </div>

            <div class="form-group">
                <label>Descrição</label>
                <input type="text" name="descricao" value="{{ current_user.tenant.descricao or '' }}">
            </div>

            <div class="form-group">
                <label>Endereço</label>
                <input type="text" name="endereco" value="{{ current_user.tenant.endereco or '' }}">
            </div>

            <div class="form-group">
                <label>WhatsApp</label>
                <input type="text" name="whatsapp" value="{{ current_user.tenant.whatsapp or '' }}">
            </div>

            <button class="btn btn-gold">Salvar</button>
        </form>
    </div>
</div>
{% endif %}

<!-- ============================= -->
<!-- JS TABS -->
<!-- ============================= -->
<script>
function openTab(evt, tabName) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>

{% endblock %}
