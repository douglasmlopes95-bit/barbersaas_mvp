{% extends "base.html" %}

{% block title %}Dashboard | Barbearia{% endblock %}

{% block content %}

<div class="header">
    <h1>Dashboard <span>Barbearia</span></h1>
</div>

<!-- ============================= -->
<!-- TABS -->
<!-- ============================= -->
<div class="tabs">
    <button class="tab-btn active" onclick="openTab(event,'overview')">Visão Geral</button>
    <button class="tab-btn" onclick="openTab(event,'services')">Serviços</button>
    <button class="tab-btn" onclick="openTab(event,'barbers')">Barbeiros</button>
    <button class="tab-btn" onclick="openTab(event,'slots')">Horários</button>
    <button class="tab-btn" onclick="openTab(event,'finance')">Financeiro</button>
    <button class="tab-btn" onclick="openTab(event,'cash')">Caixa</button>
    <button class="tab-btn" onclick="openTab(event,'reports')">Relatórios</button>
</div>

<!-- ============================= -->
<!-- VISÃO GERAL -->
<!-- ============================= -->
<div id="overview" class="tab-content active">

    <div class="cards">
        <div class="card">
            <h3>Serviços</h3>
            <p>{{ services|length }}</p>
        </div>
        <div class="card">
            <h3>Barbeiros</h3>
            <p>{{ barbers|length }}</p>
        </div>
        <div class="card">
            <h3>Agendamentos</h3>
            <p>{{ appointments|length }}</p>
        </div>
    </div>

    <div class="card">
        <h3>Agenda</h3>

        {% if appointments %}
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Cliente</th>
                    <th>Barbeiro</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                {% for appt in appointments %}
                <tr>
                    <td>{{ appt.data_hora.strftime("%d/%m/%Y %H:%M") }}</td>
                    <td>{{ appt.cliente_nome }}</td>
                    <td>
                        {% for barber in barbers %}
                            {% if barber.id == appt.barber_id %}
                                {{ barber.nome }}
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% if appt.status == "AGENDADO" %}
                            <span class="badge badge-warning">Agendado</span>
                        {% elif appt.status == "CONCLUIDO" %}
                            <span class="badge badge-success">Concluído</span>
                        {% else %}
                            <span class="badge badge-danger">Cancelado</span>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
            <p class="muted">Nenhum agendamento encontrado.</p>
        {% endif %}
    </div>
</div>

<!-- ============================= -->
<!-- SERVIÇOS -->
<!-- ============================= -->
<div id="services" class="tab-content">

    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Novo Serviço</h3>
        <form method="POST">
            <input type="hidden" name="action" value="create_service">

            <div class="form-group">
                <label>Nome</label>
                <input type="text" name="nome" required>
            </div>

            <div class="form-group">
                <label>Descrição</label>
                <input type="text" name="descricao">
            </div>

            <div class="form-group">
                <label>Preço (R$)</label>
                <input type="number" step="0.01" name="preco" required>
            </div>

            <div class="form-group">
                <label>Duração (min)</label>
                <input type="number" name="duracao" value="30">
            </div>

            <button class="btn btn-gold">Cadastrar Serviço</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Serviços Cadastrados</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>Preço</th>
                    <th>Duração</th>
                </tr>
            </thead>
            <tbody>
                {% for s in services %}
                <tr>
                    <td>{{ s.nome }}</td>
                    <td>R$ {{ "%.2f"|format(s.preco) }}</td>
                    <td>{{ s.duracao_min }} min</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- BARBEIROS -->
<!-- ============================= -->
<div id="barbers" class="tab-content">

    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Novo Barbeiro</h3>
        <form method="POST">
            <input type="hidden" name="action" value="create_barber">

            <div class="form-group">
                <label>Nome</label>
                <input type="text" name="nome" required>
            </div>

            <div class="form-group">
                <label>E-mail</label>
                <input type="email" name="email" required>
            </div>

            <div class="form-group">
                <label>Senha</label>
                <input type="password" name="senha" required>
            </div>

            <button class="btn btn-gold">Cadastrar Barbeiro</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Barbeiros Ativos</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Nome</th>
                    <th>E-mail</th>
                </tr>
            </thead>
            <tbody>
                {% for b in barbers %}
                <tr>
                    <td>{{ b.nome }}</td>
                    <td>{{ b.email }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- HORÁRIOS -->
<!-- ============================= -->
<div id="slots" class="tab-content">

    {% if current_user.is_tenant_admin() %}
    <div class="card">
        <h3>Gerar Horários</h3>
        <form method="POST">
            <input type="hidden" name="action" value="generate_slots">

            <div class="form-group">
                <label>Barbeiro</label>
                <select name="barber_id" required>
                    <option value="">Selecione</option>
                    {% for barber in barbers %}
                        <option value="{{ barber.id }}">{{ barber.nome }}</option>
                    {% endfor %}
                </select>
            </div>

            <div class="form-group">
                <label>Dias da semana</label>
                <div style="display:flex; gap:12px; flex-wrap:wrap;">
                    {% for d in [('0','Seg'),('1','Ter'),('2','Qua'),('3','Qui'),('4','Sex'),('5','Sáb'),('6','Dom')] %}
                        <label>
                            <input type="checkbox" name="weekdays" value="{{ d[0] }}"> {{ d[1] }}
                        </label>
                    {% endfor %}
                </div>
            </div>

            <div class="form-group">
                <label>Hora início</label>
                <input type="time" name="hora_inicio" required>
            </div>

            <div class="form-group">
                <label>Hora fim</label>
                <input type="time" name="hora_fim" required>
            </div>

            <div class="form-group">
                <label>Intervalo (min)</label>
                <select name="intervalo">
                    <option value="15">15</option>
                    <option value="30" selected>30</option>
                    <option value="60">60</option>
                </select>
            </div>

            <div class="form-group">
                <label>Data início</label>
                <input type="date" name="data_inicio" required>
            </div>

            <div class="form-group">
                <label>Data fim</label>
                <input type="date" name="data_fim" required>
            </div>

            <button class="btn btn-gold">Gerar Horários</button>
        </form>
    </div>
    {% endif %}

    <div class="card">
        <h3>Horários Cadastrados</h3>
        <table class="table">
            <thead>
                <tr>
                    <th>Data</th>
                    <th>Hora</th>
                    <th>Barbeiro</th>
                    <th>Status</th>
                    {% if current_user.is_tenant_admin() %}
                    <th>Ações</th>
                    {% endif %}
                </tr>
            </thead>
            <tbody>
                {% for slot in slots %}
                <tr>
                    <td>{{ slot.data.strftime("%d/%m/%Y") }}</td>
                    <td>{{ slot.hora.strftime("%H:%M") }}</td>
                    <td>
                        {% for barber in barbers %}
                            {% if barber.id == slot.barber_id %}
                                {{ barber.nome }}
                            {% endif %}
                        {% endfor %}
                    </td>
                    <td>
                        {% if slot.disponivel %}
                            <span class="badge badge-success">Disponível</span>
                        {% else %}
                            <span class="badge badge-danger">Bloqueado</span>
                        {% endif %}
                    </td>

                    {% if current_user.is_tenant_admin() %}
                    <td style="display:flex; gap:6px;">
                        <form method="POST"
                              action="{{ url_for('tenant.toggle_slot', slot_id=slot.id) }}">
                            <button class="btn btn-sm">
                                {% if slot.disponivel %}Bloquear{% else %}Liberar{% endif %}
                            </button>
                        </form>

                        <form method="POST"
                              action="{{ url_for('tenant.delete_slot', slot_id=slot.id) }}"
                              onsubmit="return confirm('Excluir este horário?');">
                            <button class="btn btn-sm btn-danger">Excluir</button>
                        </form>
                    </td>
                    {% endif %}
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- ============================= -->
<!-- FINANCEIRO -->
<!-- ============================= -->
<div id="finance" class="tab-content">
    <div class="card">
        <h3>Financeiro</h3>
        <p class="muted">
            Visualize faturamento, despesas, lucro e indicadores financeiros.
        </p>
        <a href="{{ url_for('tenant.go_reports') }}" class="btn btn-gold">
            Abrir Financeiro
        </a>
    </div>
</div>

<!-- ============================= -->
<!-- CAIXA -->
<!-- ============================= -->
<div id="cash" class="tab-content">
    <div class="card">
        <h3>Caixa</h3>
        <p class="muted">
            Controle abertura, fechamento e movimentações de caixa.
        </p>
        <a href="{{ url_for('tenant.go_cash') }}" class="btn btn-gold">
            Acessar Caixa
        </a>
    </div>
</div>

<!-- ============================= -->
<!-- RELATÓRIOS -->
<!-- ============================= -->
<div id="reports" class="tab-content">
    <div class="card">
        <h3>Relatórios Gerenciais</h3>
        <ul class="report-list">
            <li>✔ Faturamento por período</li>
            <li>✔ Serviços mais vendidos</li>
            <li>✔ Ticket médio</li>
            <li>✔ Histórico de caixa</li>
        </ul>
        <a href="{{ url_for('tenant.go_reports') }}" class="btn btn-gold">
            Ver Relatórios
        </a>
    </div>
</div>

<!-- ============================= -->
<!-- JS TABS -->
<!-- ============================= -->
<script>
function openTab(evt, tabName) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
    document.getElementById(tabName).classList.add("active");
    evt.currentTarget.classList.add("active");
}
</script>

{% endblock %}
