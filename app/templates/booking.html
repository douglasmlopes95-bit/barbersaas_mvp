{% extends "base.html" %}

{% block title %}Agendar | {{ tenant.nome }}{% endblock %}

{% block content %}

<!-- ============================= -->
<!-- HEADER BARBEARIA -->
<!-- ============================= -->
<div class="booking-header" style="text-align:center; margin-bottom:30px;">

    {% if tenant.logo_url %}
        <img
            src="{{ tenant.logo_url }}"
            alt="Logo {{ tenant.nome }}"
            style="max-height:110px; margin-bottom:12px;"
        >
    {% endif %}

    <h1 style="font-size:28px; font-weight:700;">
        Agendar em <span style="color:#d4af37;">{{ tenant.nome }}</span>
    </h1>

    {% if tenant.descricao %}
        <p style="color:#bdbdbd; margin-top:6px;">
            {{ tenant.descricao }}
        </p>
    {% endif %}

    {% if tenant.endereco or tenant.whatsapp %}
        <p style="font-size:14px; color:#9b9b9b; margin-top:10px;">

            {% if tenant.endereco %}
                üìç {{ tenant.endereco }}
            {% endif %}

            {% if tenant.endereco and tenant.whatsapp %}
                &nbsp;‚Ä¢&nbsp;
            {% endif %}

            {% if tenant.whatsapp %}
                {% set wa = tenant.whatsapp
                    |replace('(', '')
                    |replace(')', '')
                    |replace('-', '')
                    |replace(' ', '')
                %}
                üìû 
                <a href="https://wa.me/55{{ wa }}" 
                   target="_blank" 
                   style="color:#d4af37; text-decoration:none;">
                    WhatsApp: {{ tenant.whatsapp }}
                </a>
            {% endif %}
        </p>
    {% endif %}
</div>


<!-- ============================= -->
<!-- CARD AGENDAMENTO -->
<!-- ============================= -->
<div class="card" style="max-width:600px; margin:0 auto;">

<form method="POST">

    <!-- BARBEIRO -->
    <div class="form-group">
        <label>Barbeiro</label>
        <select id="barberSelect" name="barber_id" required>
            <option value="">Selecione um barbeiro</option>
            {% for barber in barbers %}
                <option value="{{ barber.id }}">
                    {{ barber.nome }}
                </option>
            {% endfor %}
        </select>
    </div>

    <!-- SERVI√áO -->
    <div class="form-group">
        <label>Servi√ßo</label>
        <select id="serviceSelect" name="service_id" required disabled>
            <option value="">Selecione um barbeiro primeiro</option>
        </select>
    </div>

    <!-- HOR√ÅRIO DISPON√çVEL -->
    <div class="form-group">
        <label>Hor√°rio dispon√≠vel</label>
        <select id="slotSelect" name="slot_id" required disabled>
            <option value="">Selecione um barbeiro primeiro</option>
        </select>
    </div>

    <!-- DADOS DO CLIENTE -->
    <div class="form-group">
        <label>Seu nome</label>
        <input
            type="text"
            name="cliente_nome"
            placeholder="Ex: Jo√£o Silva"
            required
        >
    </div>

    <div class="form-group">
        <label>WhatsApp</label>
        <input
            type="text"
            name="cliente_whatsapp"
            placeholder="(DDD) 9xxxx-xxxx"
            required
        >
    </div>

    <button class="btn btn-gold" style="width:100%; margin-top:12px;">
        Confirmar Agendamento
    </button>

</form>

</div>

<!-- ============================= -->
<!-- FOOTER -->
<!-- ============================= -->
<div style="text-align:center; margin-top:30px; font-size:13px; color:#9a9a9a;">
    Sistema de agendamento profissional ‚Ä¢ BarberSaaS
</div>

<!-- ============================= -->
<!-- JS FILTRO DIN√ÇMICO -->
<!-- ============================= -->
<script>
const services = {{ services|tojson }};
const slots = {{ slots|tojson }};

const barberSelect = document.getElementById("barberSelect");
const serviceSelect = document.getElementById("serviceSelect");
const slotSelect = document.getElementById("slotSelect");

barberSelect.addEventListener("change", () => {

    serviceSelect.innerHTML = "";
    slotSelect.innerHTML = "";

    const barberId = barberSelect.value;

    if(!barberId){
        serviceSelect.disabled = true;
        slotSelect.disabled = true;

        serviceSelect.innerHTML =
            `<option value="">Selecione um barbeiro primeiro</option>`;
        slotSelect.innerHTML =
            `<option value="">Selecione um barbeiro primeiro</option>`;

        return;
    }

    // FILTRAR SERVI√áOS DO BARBEIRO
    const filteredServices = services.filter(s => s.barber_id == barberId);

    serviceSelect.disabled = false;
    serviceSelect.innerHTML = `<option value="">Selecione um servi√ßo</option>`;

    filteredServices.forEach(s => {
        serviceSelect.innerHTML += `
            <option value="${s.id}">
                ${s.nome} ‚Äî R$ ${parseFloat(s.preco).toFixed(2)}
            </option>`;
    });

    // FILTRAR HOR√ÅRIOS DO BARBEIRO
    const filteredSlots = slots.filter(s => s.barber_id == barberId);

    slotSelect.disabled = false;
    slotSelect.innerHTML = `<option value="">Selecione um hor√°rio</option>`;

    filteredSlots.forEach(s => {
        slotSelect.innerHTML += `
            <option value="${s.id}">
                ${s.data} √†s ${s.hora}
            </option>`;
    });

});
</script>

{% endblock %}
